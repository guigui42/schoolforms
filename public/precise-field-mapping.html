<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precise Form Field Mapping</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>
<body>
    <div style="padding: 20px; font-family: Arial, sans-serif;">
        <h1>Precise Form Field Mapping</h1>
        <p>This test maps coordinates to the exact positions visible in the form.</p>
        <button onclick="testPreciseMapping()" style="padding: 10px 20px; background-color: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Test Precise Mapping
        </button>
        <div id="status" style="margin-top: 20px; padding: 10px; border-radius: 5px;"></div>
    </div>

    <script>
        async function testPreciseMapping() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<p style="color: blue;">Creating precise field mapping...</p>';
            
            try {
                // Load the PDF template
                const templatePath = '/templates/Dossier d\'inscription ALSH - EDPP 2025-2026.pdf';
                const response = await fetch(templatePath);
                if (!response.ok) {
                    throw new Error(`Failed to load template: ${response.statusText}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                const pages = pdfDoc.getPages();
                const firstPage = pages[0];
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                
                const pageWidth = firstPage.getWidth();
                const pageHeight = firstPage.getHeight();
                
                console.log(`Page dimensions: ${pageWidth} x ${pageHeight}`);
                
                // Based on visual analysis of the form, these are the approximate field positions
                const preciseFieldPositions = [
                    // Child Information Section (top section)
                    { name: 'Child_LastName', x: 150, y: 720, color: [1, 0, 0], description: 'NOM field' },
                    { name: 'Child_FirstName', x: 380, y: 720, color: [1, 0, 0], description: 'PRENOM field' },
                    { name: 'Child_BirthDate', x: 520, y: 720, color: [1, 0, 0], description: 'Birth date' },
                    
                    { name: 'Child_Born_At', x: 150, y: 690, color: [1, 0, 0], description: 'Né(e) le field' },
                    { name: 'Child_Nationality', x: 380, y: 690, color: [1, 0, 0], description: 'Nationalité field' },
                    { name: 'Child_Sex_Feminine', x: 520, y: 690, color: [1, 0, 0], description: 'Féminin checkbox' },
                    { name: 'Child_Sex_Masculine', x: 570, y: 690, color: [1, 0, 0], description: 'Masculin checkbox' },
                    
                    // Address Section
                    { name: 'Address_Street', x: 150, y: 630, color: [0, 1, 0], description: 'ADRESSE field' },
                    { name: 'Address_PostalCode', x: 150, y: 600, color: [0, 1, 0], description: 'Code postal field' },
                    { name: 'Address_City', x: 380, y: 600, color: [0, 1, 0], description: 'Ville field' },
                    
                    // Legal Representatives Section
                    { name: 'Father_LastName', x: 150, y: 520, color: [0, 0, 1], description: 'Father nom field' },
                    { name: 'Father_FirstName', x: 380, y: 520, color: [0, 0, 1], description: 'Father prénom field' },
                    { name: 'Father_Phone', x: 520, y: 520, color: [0, 0, 1], description: 'Father phone field' },
                    { name: 'Father_Email', x: 150, y: 490, color: [0, 0, 1], description: 'Father email field' },
                    
                    // Mother Section (bottom part)
                    { name: 'Mother_MaidenName', x: 380, y: 250, color: [1, 0, 1], description: 'Mother nom de jeune fille' },
                    { name: 'Mother_MaritalName', x: 520, y: 250, color: [1, 0, 1], description: 'Mother nom marital' },
                    { name: 'Mother_FirstName', x: 150, y: 220, color: [1, 0, 1], description: 'Mother prénom' },
                    { name: 'Mother_Nationality', x: 380, y: 220, color: [1, 0, 1], description: 'Mother nationalité' },
                    { name: 'Mother_Phone', x: 150, y: 120, color: [1, 0, 1], description: 'Mother mobile' },
                    { name: 'Mother_Email', x: 380, y: 120, color: [1, 0, 1], description: 'Mother email' },
                    
                    // Test corner positions for reference
                    { name: 'TOP_LEFT', x: 0, y: pageHeight, color: [0, 0, 0], description: 'Page top-left' },
                    { name: 'TOP_RIGHT', x: pageWidth, y: pageHeight, color: [0, 0, 0], description: 'Page top-right' },
                    { name: 'BOTTOM_LEFT', x: 0, y: 0, color: [0, 0, 0], description: 'Page bottom-left' },
                    { name: 'BOTTOM_RIGHT', x: pageWidth, y: 0, color: [0, 0, 0], description: 'Page bottom-right' },
                    
                    // Test center positions
                    { name: 'CENTER', x: pageWidth/2, y: pageHeight/2, color: [0.5, 0.5, 0.5], description: 'Page center' },
                    { name: 'QUARTER_HEIGHT', x: pageWidth/2, y: pageHeight/4, color: [0.5, 0.5, 0.5], description: 'Quarter height' },
                    { name: 'THREE_QUARTER_HEIGHT', x: pageWidth/2, y: 3*pageHeight/4, color: [0.5, 0.5, 0.5], description: '3/4 height' },
                ];
                
                // Draw the test positions
                preciseFieldPositions.forEach(field => {
                    // Draw position marker
                    firstPage.drawCircle({
                        x: field.x,
                        y: field.y,
                        size: 5,
                        color: PDFLib.rgb(field.color[0], field.color[1], field.color[2]),
                    });
                    
                    // Draw field name
                    firstPage.drawText(field.name, {
                        x: field.x + 8,
                        y: field.y + 8,
                        size: 8,
                        font,
                        color: PDFLib.rgb(field.color[0], field.color[1], field.color[2]),
                    });
                    
                    // Draw coordinates
                    firstPage.drawText(`(${field.x},${field.y})`, {
                        x: field.x + 8,
                        y: field.y - 8,
                        size: 6,
                        font,
                        color: PDFLib.rgb(0.5, 0.5, 0.5),
                    });
                });
                
                // Draw a reference grid (every 100 points)
                for (let x = 0; x <= pageWidth; x += 100) {
                    firstPage.drawLine({
                        start: { x: x, y: 0 },
                        end: { x: x, y: pageHeight },
                        thickness: 0.5,
                        color: PDFLib.rgb(0.9, 0.9, 0.9),
                    });
                    
                    if (x > 0) {
                        firstPage.drawText(`${x}`, {
                            x: x + 2,
                            y: pageHeight - 15,
                            size: 8,
                            font,
                            color: PDFLib.rgb(0.7, 0.7, 0.7),
                        });
                    }
                }
                
                for (let y = 0; y <= pageHeight; y += 100) {
                    firstPage.drawLine({
                        start: { x: 0, y: y },
                        end: { x: pageWidth, y: y },
                        thickness: 0.5,
                        color: PDFLib.rgb(0.9, 0.9, 0.9),
                    });
                    
                    if (y > 0) {
                        firstPage.drawText(`${y}`, {
                            x: 5,
                            y: y + 2,
                            size: 8,
                            font,
                            color: PDFLib.rgb(0.7, 0.7, 0.7),
                        });
                    }
                }
                
                // Generate and download PDF
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'precise-field-mapping.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                statusDiv.innerHTML = '<p style="color: green;">✅ Precise field mapping generated successfully!</p>';
                
                // Log the coordinates for reference
                console.log('Precise Field Coordinates:', preciseFieldPositions);
                
            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = `<p style="color: red;">❌ Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
