<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Calibration PDF</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>
<body>
    <div style="padding: 20px; font-family: Arial, sans-serif;">
        <h1>Test de Calibration PDF</h1>
        <p>Cliquez sur le bouton pour tester la génération du PDF de calibration.</p>
        <button onclick="testCalibration()" style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Test Calibration
        </button>
        <div id="status" style="margin-top: 20px; padding: 10px; border-radius: 5px;"></div>
    </div>

    <script>
        async function testCalibration() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<p style="color: blue;">Chargement du PDF...</p>';
            
            try {
                // Load the PDF template
                const templatePath = '/templates/Dossier d\'inscription ALSH - EDPP 2025-2026.pdf';
                console.log('Loading template from:', templatePath);
                
                const response = await fetch(templatePath);
                if (!response.ok) {
                    throw new Error(`Failed to load template: ${response.statusText} (${response.status})`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                console.log('PDF loaded, size:', arrayBuffer.byteLength);
                
                // Create PDF document
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                const pages = pdfDoc.getPages();
                const firstPage = pages[0];
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                
                console.log('PDF pages:', pages.length);
                console.log('First page dimensions:', firstPage.getWidth(), 'x', firstPage.getHeight());
                
                // Add test markers based on calibration results
                const testCoordinates = [
                    { name: 'Child-LastName', x: 270, y: 540, color: [1, 0, 0] },
                    { name: 'Child-FirstName', x: 400, y: 540, color: [1, 0, 0] },
                    { name: 'Child-BirthDate', x: 270, y: 510, color: [1, 0, 0] },
                    { name: 'Child-Nationality', x: 500, y: 510, color: [1, 0, 0] },
                    { name: 'Address-Street', x: 170, y: 480, color: [0, 1, 0] },
                    { name: 'Address-PostalCode', x: 270, y: 450, color: [0, 1, 0] },
                    { name: 'Address-City', x: 400, y: 450, color: [0, 1, 0] },
                    { name: 'Father-LastName', x: 270, y: 350, color: [0, 0, 1] },
                    { name: 'Father-FirstName', x: 430, y: 350, color: [0, 0, 1] },
                    { name: 'Father-Mobile', x: 200, y: 265, color: [0, 0, 1] },
                    { name: 'Father-Email', x: 370, y: 265, color: [0, 0, 1] },
                    { name: 'Mother-MaidenName', x: 430, y: 150, color: [1, 0, 1] },
                    { name: 'Mother-FirstName', x: 270, y: 120, color: [1, 0, 1] },
                    { name: 'Mother-Mobile', x: 200, y: 60, color: [1, 0, 1] },
                    { name: 'Mother-Email', x: 370, y: 60, color: [1, 0, 1] },
                    { name: 'TopLeft', x: 50, y: 800, color: [0, 0, 0] },
                    { name: 'TopRight', x: 545, y: 800, color: [0, 0, 0] },
                    { name: 'BottomLeft', x: 50, y: 50, color: [0, 0, 0] },
                    { name: 'BottomRight', x: 545, y: 50, color: [0, 0, 0] },
                ];
                
                testCoordinates.forEach((coord, index) => {
                    const color = coord.color || [1, 0, 0];
                    const fontSize = 8;
                    
                    // Draw the test text
                    firstPage.drawText(`${coord.name} (${coord.x},${coord.y})`, {
                        x: coord.x,
                        y: coord.y,
                        size: fontSize,
                        font,
                        color: PDFLib.rgb(color[0], color[1], color[2]),
                    });
                    
                    // Draw a small circle as a position marker
                    firstPage.drawCircle({
                        x: coord.x,
                        y: coord.y,
                        size: 3,
                        color: PDFLib.rgb(color[0], color[1], color[2]),
                    });
                });
                
                // Generate and download PDF
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'calibration-test.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                statusDiv.innerHTML = '<p style="color: green;">✓ PDF de calibration généré avec succès!</p>';
                
            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = `<p style="color: red;">✗ Erreur: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
