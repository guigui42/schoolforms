<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Calibrated Coordinate System</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>
<body>
    <div style="padding: 20px; font-family: Arial, sans-serif;">
        <h1>Final Calibrated Coordinate System</h1>
        <p>This test uses the calibrated coordinates based on visual analysis of the form.</p>
        <button onclick="testCalibratedSystem()" style="padding: 10px 20px; background-color: #FF5722; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Test Calibrated System
        </button>
        <div id="status" style="margin-top: 20px; padding: 10px; border-radius: 5px;"></div>
        <pre id="coordinates" style="background: #f5f5f5; padding: 10px; margin-top: 20px; font-size: 12px;"></pre>
    </div>

    <script>
        // FINAL CALIBRATED COORDINATE SYSTEM
        // Based on visual analysis of the actual form
        
        const CALIBRATED_COORDINATES = {
            // Page properties
            pageWidth: 595.28,
            pageHeight: 841.89,
            
            // Child Information Section (top part of form)
            childLastName: { x: 150, y: 740, width: 200, label: "NOM" },
            childFirstName: { x: 380, y: 740, width: 140, label: "PRENOM" },
            childBirthDate: { x: 520, y: 740, width: 60, label: "Date naissance" },
            
            childBornAt: { x: 150, y: 710, width: 200, label: "Né(e) le" },
            childNationality: { x: 380, y: 710, width: 140, label: "Nationalité" },
            childSexFeminine: { x: 520, y: 710, width: 20, label: "Féminin" },
            childSexMasculine: { x: 570, y: 710, width: 20, label: "Masculin" },
            
            // Address Section
            addressStreet: { x: 150, y: 630, width: 400, label: "ADRESSE" },
            addressPostalCode: { x: 150, y: 600, width: 100, label: "Code postal" },
            addressCity: { x: 300, y: 600, width: 200, label: "Ville" },
            
            // Legal Representatives / Father Section
            fatherLastName: { x: 150, y: 520, width: 200, label: "Nom du père" },
            fatherFirstName: { x: 380, y: 520, width: 140, label: "Prénom du père" },
            fatherPhone: { x: 520, y: 520, width: 100, label: "Téléphone père" },
            
            // Father contact details
            fatherEmail: { x: 150, y: 490, width: 300, label: "Email du père" },
            fatherProfession: { x: 150, y: 460, width: 200, label: "Profession père" },
            fatherEmployer: { x: 380, y: 460, width: 160, label: "Employeur père" },
            fatherMobile: { x: 150, y: 430, width: 150, label: "Mobile père" },
            
            // Mother Section
            motherMaidenName: { x: 380, y: 300, width: 140, label: "Nom de jeune fille" },
            motherMaritalName: { x: 520, y: 300, width: 100, label: "Nom marital" },
            motherFirstName: { x: 150, y: 270, width: 200, label: "Prénom mère" },
            motherNationality: { x: 380, y: 270, width: 140, label: "Nationalité mère" },
            
            // Mother contact details
            motherProfession: { x: 150, y: 180, width: 200, label: "Profession mère" },
            motherEmployer: { x: 380, y: 180, width: 160, label: "Employeur mère" },
            motherMobile: { x: 150, y: 150, width: 150, label: "Mobile mère" },
            motherEmail: { x: 380, y: 150, width: 200, label: "Email mère" }
        };

        async function testCalibratedSystem() {
            const statusDiv = document.getElementById('status');
            const coordinatesDiv = document.getElementById('coordinates');
            
            statusDiv.innerHTML = '<p style="color: blue;">Testing calibrated coordinate system...</p>';
            
            try {
                // Load the PDF template
                const templatePath = '/templates/Dossier d\'inscription ALSH - EDPP 2025-2026.pdf';
                const response = await fetch(templatePath);
                if (!response.ok) {
                    throw new Error(`Failed to load template: ${response.statusText}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                const pages = pdfDoc.getPages();
                const firstPage = pages[0];
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                
                console.log('Testing calibrated coordinates...');
                
                // Test each calibrated field position
                Object.entries(CALIBRATED_COORDINATES).forEach(([fieldName, coords]) => {
                    if (typeof coords === 'object' && coords.x !== undefined) {
                        // Determine color based on section
                        let color = [0, 0, 0]; // default black
                        if (fieldName.startsWith('child')) color = [1, 0, 0]; // red
                        else if (fieldName.startsWith('address')) color = [0, 1, 0]; // green
                        else if (fieldName.startsWith('father')) color = [0, 0, 1]; // blue
                        else if (fieldName.startsWith('mother')) color = [1, 0, 1]; // magenta
                        
                        // Draw position marker
                        firstPage.drawCircle({
                            x: coords.x,
                            y: coords.y,
                            size: 4,
                            color: PDFLib.rgb(color[0], color[1], color[2]),
                        });
                        
                        // Draw field name
                        firstPage.drawText(fieldName, {
                            x: coords.x + 8,
                            y: coords.y + 8,
                            size: 7,
                            font,
                            color: PDFLib.rgb(color[0], color[1], color[2]),
                        });
                        
                        // Draw coordinates
                        firstPage.drawText(`(${coords.x},${coords.y})`, {
                            x: coords.x + 8,
                            y: coords.y - 8,
                            size: 6,
                            font,
                            color: PDFLib.rgb(0.5, 0.5, 0.5),
                        });
                        
                        // Draw field boundary (if width is specified)
                        if (coords.width) {
                            firstPage.drawRectangle({
                                x: coords.x,
                                y: coords.y - 5,
                                width: coords.width,
                                height: 15,
                                borderColor: PDFLib.rgb(color[0], color[1], color[2]),
                                borderWidth: 0.5,
                            });
                        }
                    }
                });
                
                // Add some sample text to test text positioning
                const sampleData = {
                    childLastName: "DUPONT",
                    childFirstName: "Jean",
                    childBirthDate: "15/03/2018",
                    childBornAt: "Paris",
                    childNationality: "Française",
                    addressStreet: "123 Rue de la Paix",
                    addressPostalCode: "75001",
                    addressCity: "Paris",
                    fatherLastName: "DUPONT",
                    fatherFirstName: "Pierre",
                    fatherPhone: "01.23.45.67.89",
                    fatherEmail: "pierre.dupont@email.com",
                    motherMaidenName: "MARTIN",
                    motherFirstName: "Marie",
                    motherMobile: "06.12.34.56.78",
                    motherEmail: "marie.dupont@email.com"
                };
                
                // Draw sample data
                Object.entries(sampleData).forEach(([fieldName, value]) => {
                    const coords = CALIBRATED_COORDINATES[fieldName];
                    if (coords) {
                        firstPage.drawText(value, {
                            x: coords.x,
                            y: coords.y - 20,
                            size: 9,
                            font,
                            color: PDFLib.rgb(0, 0, 0.8),
                        });
                    }
                });
                
                // Generate and download PDF
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'calibrated-coordinate-system.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                statusDiv.innerHTML = '<p style="color: green;">✅ Calibrated coordinate system test completed!</p>';
                
                // Display calibrated coordinates
                coordinatesDiv.textContent = 'CALIBRATED COORDINATES:\n\n' + 
                    JSON.stringify(CALIBRATED_COORDINATES, null, 2);
                
                // Log field mapping for easy copy-paste
                console.log('FIELD MAPPING OBJECT:', CALIBRATED_COORDINATES);
                
            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = `<p style="color: red;">❌ Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
