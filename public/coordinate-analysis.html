<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse des Coordonn√©es PDF</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .info-box {
            background: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .info-box h3 {
            margin-top: 0;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .button-group {
            text-align: center;
            margin: 20px 0;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .coordinate-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .coordinate-info h4 {
            margin-top: 0;
            color: #495057;
        }
        code {
            background: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Analyse des Coordonn√©es PDF</h1>
        
        <div class="info-box">
            <h3>Syst√®me de Coordonn√©es PDF</h3>
            <p><strong>PDF:</strong> L'origine (0,0) se trouve en <strong>bas √† gauche</strong></p>
            <p><strong>Visuel:</strong> L'origine (0,0) se trouve en <strong>haut √† gauche</strong></p>
            <p><strong>Conversion:</strong> <code>PDF_Y = HAUTEUR_PAGE - VISUEL_Y</code></p>
        </div>

        <div class="info-box">
            <h3>Dimensions du PDF</h3>
            <p><strong>Largeur:</strong> <span id="pdf-width">Chargement...</span></p>
            <p><strong>Hauteur:</strong> <span id="pdf-height">Chargement...</span></p>
            <p><strong>Format:</strong> <span id="pdf-format">Chargement...</span></p>
        </div>

        <div class="button-group">
            <button onclick="generateGrid()">üî¢ G√©n√©rer Grille de Coordonn√©es</button>
            <button onclick="analyzeFields()">üìç Analyser les Champs</button>
            <button onclick="testCurrentCoordinates()">üéØ Tester Coordonn√©es Actuelles</button>
        </div>

        <div id="analysis-results"></div>
        <div id="status"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script>
        let pdfDimensions = null;
        
        // Load PDF and get dimensions
        async function loadPDFInfo() {
            try {
                const templatePath = '/templates/Dossier d\'inscription ALSH - EDPP 2025-2026.pdf';
                const response = await fetch(templatePath);
                const arrayBuffer = await response.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                const pages = pdfDoc.getPages();
                const firstPage = pages[0];
                const { width, height } = firstPage.getSize();
                
                pdfDimensions = { width, height };
                
                document.getElementById('pdf-width').textContent = `${width.toFixed(2)} points`;
                document.getElementById('pdf-height').textContent = `${height.toFixed(2)} points`;
                document.getElementById('pdf-format').textContent = 'A4 (595.32 x 841.92)';
                
                console.log('PDF charg√©:', pdfDimensions);
                
            } catch (error) {
                console.error('Erreur lors du chargement du PDF:', error);
                document.getElementById('status').innerHTML = `<p style="color: red;">Erreur: ${error.message}</p>`;
            }
        }

        // Convert visual coordinates to PDF coordinates
        function visualToPDF(visualX, visualY) {
            if (!pdfDimensions) return { x: visualX, y: visualY };
            return {
                x: visualX,
                y: pdfDimensions.height - visualY
            };
        }

        // Generate coordinate grid
        async function generateGrid() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<p style="color: blue;">G√©n√©ration de la grille...</p>';
            
            try {
                const templatePath = '/templates/Dossier d\'inscription ALSH - EDPP 2025-2026.pdf';
                const response = await fetch(templatePath);
                const arrayBuffer = await response.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                const pages = pdfDoc.getPages();
                const firstPage = pages[0];
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                
                const { width, height } = firstPage.getSize();
                const gridSpacing = 50;

                // Draw grid lines
                for (let x = 0; x <= width; x += gridSpacing) {
                    firstPage.drawLine({
                        start: { x, y: 0 },
                        end: { x, y: height },
                        thickness: 0.5,
                        color: PDFLib.rgb(0.8, 0.8, 0.8),
                    });
                    
                    if (x % 100 === 0) {
                        firstPage.drawText(`${x}`, {
                            x: x + 2,
                            y: height - 20,
                            size: 8,
                            font,
                            color: PDFLib.rgb(0.5, 0.5, 0.5),
                        });
                    }
                }

                for (let y = 0; y <= height; y += gridSpacing) {
                    firstPage.drawLine({
                        start: { x: 0, y },
                        end: { x: width, y },
                        thickness: 0.5,
                        color: PDFLib.rgb(0.8, 0.8, 0.8),
                    });
                    
                    if (y % 100 === 0) {
                        firstPage.drawText(`${y}`, {
                            x: 5,
                            y: y + 2,
                            size: 8,
                            font,
                            color: PDFLib.rgb(0.5, 0.5, 0.5),
                        });
                    }
                }

                // Add corner markers
                const corners = [
                    { x: 0, y: 0, label: 'PDF (0,0)' },
                    { x: width, y: 0, label: `PDF (${width.toFixed(0)},0)` },
                    { x: 0, y: height, label: `PDF (0,${height.toFixed(0)})` },
                    { x: width, y: height, label: `PDF (${width.toFixed(0)},${height.toFixed(0)})` },
                ];

                corners.forEach(corner => {
                    firstPage.drawRectangle({
                        x: corner.x - 5,
                        y: corner.y - 5,
                        width: 10,
                        height: 10,
                        color: PDFLib.rgb(1, 0, 0),
                    });
                    
                    firstPage.drawText(corner.label, {
                        x: corner.x + 15,
                        y: corner.y - 5,
                        size: 10,
                        font,
                        color: PDFLib.rgb(1, 0, 0),
                    });
                });

                // Add coordinate system info
                firstPage.drawText('Syst√®me de coordonn√©es PDF: (0,0) = bas-gauche', {
                    x: 50,
                    y: height - 50,
                    size: 12,
                    font,
                    color: PDFLib.rgb(0, 0, 0),
                });

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'coordinate-grid.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                statusDiv.innerHTML = '<p style="color: green;">‚úì Grille g√©n√©r√©e!</p>';
                
            } catch (error) {
                statusDiv.innerHTML = `<p style="color: red;">‚úó Erreur: ${error.message}</p>`;
            }
        }

        // Analyze field positions based on visual inspection
        async function analyzeFields() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('analysis-results');
            
            statusDiv.innerHTML = '<p style="color: blue;">Analyse des champs...</p>';
            
            try {
                await loadPDFInfo();
                
                // Based on visual inspection of the form, estimate field positions
                // These are rough estimates in visual coordinates (top-left origin)
                const visualFields = [
                    { name: 'Child-LastName', visualX: 270, visualY: 300 },
                    { name: 'Child-FirstName', visualX: 400, visualY: 300 },
                    { name: 'Child-BirthDate', visualX: 270, visualY: 330 },
                    { name: 'Child-Nationality', visualX: 500, visualY: 330 },
                    { name: 'Address-Street', visualX: 170, visualY: 370 },
                    { name: 'Address-PostalCode', visualX: 270, visualY: 400 },
                    { name: 'Address-City', visualX: 400, visualY: 400 },
                    { name: 'Father-LastName', visualX: 270, visualY: 490 },
                    { name: 'Father-FirstName', visualX: 430, visualY: 490 },
                    { name: 'Father-Mobile', visualX: 200, visualY: 580 },
                    { name: 'Father-Email', visualX: 370, visualY: 580 },
                    { name: 'Mother-MaidenName', visualX: 430, visualY: 690 },
                    { name: 'Mother-FirstName', visualX: 270, visualY: 720 },
                    { name: 'Mother-Mobile', visualX: 200, visualY: 780 },
                    { name: 'Mother-Email', visualX: 370, visualY: 780 },
                ];

                let html = '<div class="coordinate-info"><h4>Analyse des Positions de Champs</h4>';
                html += '<p>Conversion des coordonn√©es visuelles vers coordonn√©es PDF:</p>';
                html += '<table border="1" style="width: 100%; border-collapse: collapse;">';
                html += '<tr><th>Champ</th><th>Visuel X</th><th>Visuel Y</th><th>PDF X</th><th>PDF Y</th></tr>';
                
                visualFields.forEach(field => {
                    const pdfCoords = visualToPDF(field.visualX, field.visualY);
                    html += `<tr>
                        <td>${field.name}</td>
                        <td>${field.visualX}</td>
                        <td>${field.visualY}</td>
                        <td>${pdfCoords.x.toFixed(0)}</td>
                        <td>${pdfCoords.y.toFixed(0)}</td>
                    </tr>`;
                });
                
                html += '</table></div>';
                resultsDiv.innerHTML = html;
                
                statusDiv.innerHTML = '<p style="color: green;">‚úì Analyse termin√©e!</p>';
                
            } catch (error) {
                statusDiv.innerHTML = `<p style="color: red;">‚úó Erreur: ${error.message}</p>`;
            }
        }

        // Test current coordinates
        async function testCurrentCoordinates() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<p style="color: blue;">Test des coordonn√©es actuelles...</p>';
            
            try {
                const templatePath = '/templates/Dossier d\'inscription ALSH - EDPP 2025-2026.pdf';
                const response = await fetch(templatePath);
                const arrayBuffer = await response.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                const pages = pdfDoc.getPages();
                const firstPage = pages[0];
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                
                // Current coordinates from our calibration
                const testCoordinates = [
                    { name: 'Child-LastName', x: 270, y: 540, color: [1, 0, 0] },
                    { name: 'Child-FirstName', x: 400, y: 540, color: [1, 0, 0] },
                    { name: 'Child-BirthDate', x: 270, y: 510, color: [1, 0, 0] },
                    { name: 'Child-Nationality', x: 500, y: 510, color: [1, 0, 0] },
                    { name: 'Address-Street', x: 170, y: 480, color: [0, 1, 0] },
                    { name: 'Address-PostalCode', x: 270, y: 450, color: [0, 1, 0] },
                    { name: 'Address-City', x: 400, y: 450, color: [0, 1, 0] },
                    { name: 'Father-LastName', x: 270, y: 350, color: [0, 0, 1] },
                    { name: 'Father-FirstName', x: 430, y: 350, color: [0, 0, 1] },
                    { name: 'Father-Mobile', x: 200, y: 265, color: [0, 0, 1] },
                    { name: 'Father-Email', x: 370, y: 265, color: [0, 0, 1] },
                    { name: 'Mother-MaidenName', x: 430, y: 150, color: [1, 0, 1] },
                    { name: 'Mother-FirstName', x: 270, y: 120, color: [1, 0, 1] },
                    { name: 'Mother-Mobile', x: 200, y: 60, color: [1, 0, 1] },
                    { name: 'Mother-Email', x: 370, y: 60, color: [1, 0, 1] },
                ];

                testCoordinates.forEach(coord => {
                    const color = coord.color || [1, 0, 0];
                    
                    firstPage.drawText(`${coord.name}`, {
                        x: coord.x,
                        y: coord.y,
                        size: 8,
                        font,
                        color: PDFLib.rgb(color[0], color[1], color[2]),
                    });
                    
                    firstPage.drawCircle({
                        x: coord.x,
                        y: coord.y,
                        size: 3,
                        color: PDFLib.rgb(color[0], color[1], color[2]),
                    });
                });

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'current-coordinates-test.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                statusDiv.innerHTML = '<p style="color: green;">‚úì Test des coordonn√©es termin√©!</p>';
                
            } catch (error) {
                statusDiv.innerHTML = `<p style="color: red;">‚úó Erreur: ${error.message}</p>`;
            }
        }

        // Load PDF info on page load
        window.addEventListener('load', loadPDFInfo);
    </script>
</body>
</html>
